
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Connecting to Sources

We will be working with two distinct datasets from the [NY taxi dataset](https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page): the *trips* dataset, encompassing a range of trip details, and the *zones* dataset, which serves as a reference lookup for various New York zones. Notably, the *trips* data will be sourced from basic text files, whereas the *zones* data will be retrieved directly from a PostgreSQL database. As we navigate through this process, we will aslo illustrate how Dozer performs on-the-fly transformations and effectively replicates the data on the sink database.
<!--::::info
This tutorial can be run using **Dozer Live** or **Dozer CLI**. Dozer Live is an interactive browser-based UI for faster development,
while Dozer CLI is the standard Dozer Command Line Interface. 

Select the desired option, and follow the steps below:

<Tabs groupId="tool">
  <TabItem value="live" label="Dozer Live">
  </TabItem>
  <TabItem value="cli" label="Dozer CLI">
  </TabItem>
</Tabs>

::::
-->
## Sourcing trips data from local storage

Open a new file `dozer-config.yaml` and add the following configuration section:

```yaml
cache_max_map_size: 10737418240
version: 1
app_name: ny-taxi-sample
connections:
  - config: !LocalStorage
      details:
        path: ./data
      tables:
        - !Table
          name: trips
          config: !Parquet
            path: trips
            extension: .parquet
    name: local_storage

sources:
  - name: trips
    table_name: trips
    connection: local_storage

sinks:
  - table_name: trips
    config: !Dummy
```

Now download some sample trip data and copy it to the `data/trips` directory:

```bash 
curl --create-dirs -o \
  data/trips/yellow_tripdata_2023-01.parquet \
  https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2023-01.parquet
```



Start Dozer with the command:

```bash
dozer run --enable-progress
```

You should be seeing a screen like the following
```
  INFO Source: Initializing input schema: trips
+-----------------------+-----------+----------+-------+
| Field                 | Type      | Nullable | PK    |
+-----------------------+-----------+----------+-------+
| VendorID              | Int       | true     | false |
+-----------------------+-----------+----------+-------+
| tpep_pickup_datetime  | Timestamp | true     | false |
+-----------------------+-----------+----------+-------+
| tpep_dropoff_datetime | Timestamp | true     | false |
+-----------------------+-----------+----------+-------+
| passenger_count       | Float     | true     | false |
+-----------------------+-----------+----------+-------+
| trip_distance         | Float     | true     | false |
+-----------------------+-----------+----------+-------+
| RatecodeID            | Float     | true     | false |
+-----------------------+-----------+----------+-------+
| store_and_fwd_flag    | String    | true     | false |
+-----------------------+-----------+----------+-------+
| PULocationID          | Int       | true     | false |
+-----------------------+-----------+----------+-------+
| DOLocationID          | Int       | true     | false |
+-----------------------+-----------+----------+-------+
| payment_type          | Int       | true     | false |
+-----------------------+-----------+----------+-------+
| fare_amount           | Float     | true     | false |
+-----------------------+-----------+----------+-------+
| extra                 | Float     | true     | false |
+-----------------------+-----------+----------+-------+
| mta_tax               | Float     | true     | false |
+-----------------------+-----------+----------+-------+
| tip_amount            | Float     | true     | false |
+-----------------------+-----------+----------+-------+
| tolls_amount          | Float     | true     | false |
+-----------------------+-----------+----------+-------+
| improvement_surcharge | Float     | true     | false |
+-----------------------+-----------+----------+-------+
| total_amount          | Float     | true     | false |
+-----------------------+-----------+----------+-------+
| congestion_surcharge  | Float     | true     | false |
+-----------------------+-----------+----------+-------+
| airport_fee           | Float     | true     | false |
+-----------------------+-----------+----------+-------+
    
 INFO [pipeline] Validation completed    
 INFO Starting Internal Server on 0.0.0.0:50053    
▹▹▹▹▹ trips: 0: 0/s                                                                   INFO Source Object has been added: Path { raw: "trips/yellow_tripdata_2023-01.parquet" }, 2024-02-06T10:15:48.048360070Z    
 INFO Source Object has been added: Path { raw: "trips/yellow_tripdata_2023-01.parquet" }, 2024-02-06T10:15:48.048360070Z    
 INFO Rate: 295482 op/s, Processed 1000 records. Elapsed 3.384432ms    
▸▹▹▹▹ trips: 1024: 13,115.2887/s                                                      
INFO Rate: 338859 op/s, Processed 2000 records. Elapsed 2.951195ms    
▹▸▹▹▹ trips: 2048: 13,563.5544/s                                                      
INFO Rate: 337127 op/s, Processed 3000 records. Elapsed 2.966332ms    
▹▹▸▹▹ trips: 3072: 14,419.6447/s                                                     
```

This means Dozer is succesfully running. Now we can add one more connection to our `dozer-config.yaml`.




## Adding a PostgreSQL connection

We will now be adding a second connection to a PostgreSQL database. For simplicity, we will use [Supabase](htpps://www.supabase.com), a fully managed PostgreSQL database service.

Head over to [Supabase](htpps://www.supabase.com) and create a new project. Create a new table named `zones` and import the data from [this CSV file](https://d37ci6vzurychx.cloudfront.net/misc/taxi+_zone_lookup.csv). To do that, click on the button **Import data via spreadsheet** when creating a  new table in Supabase. Upload the CSV file and select `LocationID` as primary key.

Once created, head over to your project settings in Supabase, click on **Database** and take note of the **Connection Info** details. These will be used in the Dozer configuration to connect to this database instance.

Now edit your `dozer-config.yaml` and add a new PostgreSQL connection, a new source and a new endpoint. The new `dozer-config.yaml` file should look like this:

```yaml
cache_max_map_size: 10000000000
app_name: ny-taxi-sample
connections:
  - config: !LocalStorage
      details:
        path: ./data
      tables:
        - !Table
          name: trips
          config: !Parquet
            path: trips
            extension: .parquet
    name: local_storage

  - config: !Postgres
      user: ** Your Supabase user ** (generally postgres)
      password: ** Your Supabase password **
      host: ** Your Supabase host **
      port: ** Your Supabase port ** (generally 5432)
      database: postgres
    name: pg

sources:
  - name: trips
    table_name: trips
    connection: local_storage

  - name: zones
    table_name: zones
    connection: pg

sinks:
  - table_name: trips
    config: !Dummy

  - table_name: zones
    config: !Dummy
```

Now you can restart Dozer. You will notice that a new collection called `zones` is available. In the next section we will be adding SQL transformations to our data sources.
